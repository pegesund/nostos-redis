# Test set operations

redisConnect(url: String) = __native__("Redis.connect", url)
redisDel(conn, key: String) = { __native__("Redis.del", conn, key); receive { msg -> msg } }
redisSadd(conn, key: String, member: String) = { __native__("Redis.sadd", conn, key, member); receive { msg -> msg } }
redisSmembers(conn, key: String) = { __native__("Redis.smembers", conn, key); receive { msg -> msg } }
redisSismember(conn, key: String, member: String) = { __native__("Redis.sismember", conn, key, member); receive { msg -> msg } }
redisScard(conn, key: String) = { __native__("Redis.scard", conn, key); receive { msg -> msg } }
redisSunion(conn, keys: List[String]) = { __native__("Redis.sunion", conn, keys); receive { msg -> msg } }
redisSinter(conn, keys: List[String]) = { __native__("Redis.sinter", conn, keys); receive { msg -> msg } }
redisSdiff(conn, keys: List[String]) = { __native__("Redis.sdiff", conn, keys); receive { msg -> msg } }

isOk(result) = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing Set Operations ===")
    conn = redisConnect("redis://127.0.0.1/")

    redisDel(conn, "test:set1")
    redisDel(conn, "test:set2")

    check("SADD", isOk(redisSadd(conn, "test:set1", "a")))
    redisSadd(conn, "test:set1", "b")
    redisSadd(conn, "test:set1", "c")

    ("ok", scard) = redisScard(conn, "test:set1")
    check("SCARD", scard == 3)

    ("ok", sismember) = redisSismember(conn, "test:set1", "a")
    check("SISMEMBER", sismember == true)

    ("ok", members) = redisSmembers(conn, "test:set1")
    check("SMEMBERS", length(members) == 3)

    redisSadd(conn, "test:set2", "b")
    redisSadd(conn, "test:set2", "c")
    redisSadd(conn, "test:set2", "d")

    keys1: List[String] = ["test:set1", "test:set2"]
    ("ok", sunion) = redisSunion(conn, keys1)
    check("SUNION", length(sunion) == 4)

    keys2: List[String] = ["test:set1", "test:set2"]
    ("ok", sinter) = redisSinter(conn, keys2)
    check("SINTER", length(sinter) == 2)

    keys3: List[String] = ["test:set1", "test:set2"]
    ("ok", sdiff) = redisSdiff(conn, keys3)
    check("SDIFF", length(sdiff) == 1)

    redisDel(conn, "test:set1")
    redisDel(conn, "test:set2")
    println("Set tests completed!")
    0
}
