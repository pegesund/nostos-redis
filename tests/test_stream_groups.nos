# Test Stream Consumer Group variants

redisConnect(url: String) = __native__("Redis.connect", url)
redisDel(conn, key: String) = { __native__("Redis.del", conn, key); receive { msg -> msg } }
redisXadd(conn, stream: String, fields: List[(String, String)]) = { __native__("Redis.xadd", conn, stream, fields); receive { msg -> msg } }
redisXgroupCreate(conn, stream: String, group: String, startId: String) = { __native__("Redis.xgroup_create", conn, stream, group, startId); receive { msg -> msg } }
redisXgroupCreateMkstream(conn, stream: String, group: String, startId: String) = { __native__("Redis.xgroup_create", conn, stream, group, startId, true); receive { msg -> msg } }
redisXreadgroup(conn, group: String, consumer: String, streams: List[(String, String)]) = { __native__("Redis.xreadgroup", conn, group, consumer, streams); receive { msg -> msg } }
redisXreadgroupCount(conn, group: String, consumer: String, streams: List[(String, String)], count: Int) = { __native__("Redis.xreadgroup", conn, group, consumer, streams, count); receive { msg -> msg } }
redisXreadgroupBlock(conn, group: String, consumer: String, streams: List[(String, String)], count: Int, blockMs: Int) = { __native__("Redis.xreadgroup", conn, group, consumer, streams, count, blockMs); receive { msg -> msg } }
redisXack(conn, stream: String, group: String, ids: List[String]) = { __native__("Redis.xack", conn, stream, group, ids); receive { msg -> msg } }

isOk(result) = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing XREADGROUP Variants ===")
    conn = redisConnect("redis://127.0.0.1/")

    redisDel(conn, "test:grp")
    redisDel(conn, "test:mkstream2")

    # Test MKSTREAM - creates stream if doesn't exist
    check("XGROUP CREATE MKSTREAM", isOk(redisXgroupCreateMkstream(conn, "test:mkstream2", "grp1", "$")))

    # Add entries to mkstream
    fa: List[(String, String)] = [("a", "1")]
    fb: List[(String, String)] = [("a", "2")]
    redisXadd(conn, "test:mkstream2", fa)
    redisXadd(conn, "test:mkstream2", fb)

    # Read from mkstream group
    mkstreams: List[(String, String)] = [("test:mkstream2", ">")]
    ("ok", mk1) = redisXreadgroup(conn, "grp1", "c1", mkstreams)
    check("XREADGROUP from mkstream", length(mk1) > 0)

    # Setup main test stream
    fx1: List[(String, String)] = [("x", "1")]
    fx2: List[(String, String)] = [("x", "2")]
    fx3: List[(String, String)] = [("x", "3")]
    fx4: List[(String, String)] = [("x", "4")]
    fx5: List[(String, String)] = [("x", "5")]
    ("ok", id1) = redisXadd(conn, "test:grp", fx1)
    ("ok", id2) = redisXadd(conn, "test:grp", fx2)
    ("ok", id3) = redisXadd(conn, "test:grp", fx3)
    ("ok", id4) = redisXadd(conn, "test:grp", fx4)
    ("ok", id5) = redisXadd(conn, "test:grp", fx5)

    redisXgroupCreate(conn, "test:grp", "mygrp", "0")

    # Basic XREADGROUP
    grpStreams1: List[(String, String)] = [("test:grp", ">")]
    ("ok", r1) = redisXreadgroup(conn, "mygrp", "worker", grpStreams1)
    check("XREADGROUP basic", length(r1) > 0)

    # Add more for COUNT test
    fx6: List[(String, String)] = [("x", "6")]
    fx7: List[(String, String)] = [("x", "7")]
    redisXadd(conn, "test:grp", fx6)
    redisXadd(conn, "test:grp", fx7)

    grpStreams2: List[(String, String)] = [("test:grp", ">")]
    ("ok", r2) = redisXreadgroupCount(conn, "mygrp", "worker", grpStreams2, 1)
    check("XREADGROUP COUNT", isOk(("ok", r2)))

    # BLOCK test (short timeout)
    grpStreams3: List[(String, String)] = [("test:grp", ">")]
    ("ok", r3) = redisXreadgroupBlock(conn, "mygrp", "worker", grpStreams3, 5, 100)
    check("XREADGROUP BLOCK", isOk(("ok", r3)))

    # ACK
    ackIds: List[String] = [id1, id2]
    ("ok", acked) = redisXack(conn, "test:grp", "mygrp", ackIds)
    check("XACK", acked >= 0)

    redisDel(conn, "test:grp")
    redisDel(conn, "test:mkstream2")
    println("XREADGROUP tests completed!")
    0
}
