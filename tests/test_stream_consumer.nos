# Test Stream Consumer Group operations

redisConnect(url: String) = __native__("Redis.connect", url)
redisDel(conn, key: String) = { __native__("Redis.del", conn, key); receive { msg -> msg } }
redisXadd(conn, stream: String, fields: List[(String, String)]) = { __native__("Redis.xadd", conn, stream, fields); receive { msg -> msg } }
redisXlen(conn, stream: String) = { __native__("Redis.xlen", conn, stream); receive { msg -> msg } }
redisXrange(conn, stream: String, startId: String, endId: String) = { __native__("Redis.xrange", conn, stream, startId, endId); receive { msg -> msg } }
redisXread(conn, streams: List[(String, String)]) = { __native__("Redis.xread", conn, streams); receive { msg -> msg } }
redisXgroupCreate(conn, stream: String, group: String, startId: String) = { __native__("Redis.xgroup_create", conn, stream, group, startId); receive { msg -> msg } }
redisXgroupCreateMkstream(conn, stream: String, group: String, startId: String) = { __native__("Redis.xgroup_create", conn, stream, group, startId, true); receive { msg -> msg } }
redisXreadgroup(conn, group: String, consumer: String, streams: List[(String, String)]) = { __native__("Redis.xreadgroup", conn, group, consumer, streams); receive { msg -> msg } }
redisXack(conn, stream: String, group: String, ids: List[String]) = { __native__("Redis.xack", conn, stream, group, ids); receive { msg -> msg } }
redisXinfoGroups(conn, stream: String) = { __native__("Redis.xinfo_groups", conn, stream); receive { msg -> msg } }

isOk(result) = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing Stream Consumer Groups ===")
    conn = redisConnect("redis://127.0.0.1/")

    # Clean up
    redisDel(conn, "test:stream2")

    # Create stream with an entry
    fields1: List[(String, String)] = [("event", "login"), ("user", "alice")]
    ("ok", id1) = redisXadd(conn, "test:stream2", fields1)
    check("XADD 1", id1 != "")

    fields2: List[(String, String)] = [("event", "logout"), ("user", "bob")]
    ("ok", id2) = redisXadd(conn, "test:stream2", fields2)
    check("XADD 2", id2 != "")

    # Read without consumer group
    readStreams: List[(String, String)] = [("test:stream2", "0")]
    ("ok", entries) = redisXread(conn, readStreams)
    check("XREAD", length(entries) > 0)

    # Create consumer group
    check("XGROUP CREATE", isOk(redisXgroupCreate(conn, "test:stream2", "mygroup", "0")))

    # Get group info
    ("ok", groups) = redisXinfoGroups(conn, "test:stream2")
    check("XINFO GROUPS", length(groups) > 0)

    # Read as consumer - use ">" to get new undelivered messages
    # But since we created group at "0", all messages are "new" to the group
    groupStreams: List[(String, String)] = [("test:stream2", ">")]
    ("ok", groupEntries) = redisXreadgroup(conn, "mygroup", "worker1", groupStreams)
    check("XREADGROUP", length(groupEntries) > 0)

    # Acknowledge the messages
    ackIds: List[String] = [id1, id2]
    ("ok", ackCount) = redisXack(conn, "test:stream2", "mygroup", ackIds)
    check("XACK", ackCount == 2)

    # Cleanup
    redisDel(conn, "test:stream2")

    println("Stream consumer group tests completed!")
    0
}
