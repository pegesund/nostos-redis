# Test stream operations
type Conn = { handle: Any }

redisConnect(url: String) -> Conn = Conn(__native__("Redis.connect", url))
redisDel(conn: Conn, key: String) = { __native__("Redis.del", conn.handle, key); receive { msg -> msg } }
redisXadd(conn: Conn, stream: String, fields: List) = { __native__("Redis.xadd", conn.handle, stream, fields); receive { msg -> msg } }
redisXlen(conn: Conn, stream: String) = { __native__("Redis.xlen", conn.handle, stream); receive { msg -> msg } }
redisXrange(conn: Conn, stream: String, startId: String, endId: String) = { __native__("Redis.xrange", conn.handle, stream, startId, endId); receive { msg -> msg } }

isOk(result: (String, Any)) -> Bool = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing Stream Operations ===")
    conn = redisConnect("redis://127.0.0.1/")

    redisDel(conn, "test:stream")

    ("ok", id1) = redisXadd(conn, "test:stream", [("field1", "value1")])
    check("XADD", length(id1) > 0)

    redisXadd(conn, "test:stream", [("field2", "value2")])

    ("ok", xlen) = redisXlen(conn, "test:stream")
    check("XLEN", xlen == 2)

    ("ok", xrange) = redisXrange(conn, "test:stream", "-", "+")
    check("XRANGE", length(xrange) == 2)

    redisDel(conn, "test:stream")
    println("Stream tests completed!")
    0
}
