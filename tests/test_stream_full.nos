# Test all Stream operations including variants

redisConnect(url: String) = __native__("Redis.connect", url)
redisDel(conn, key: String) = { __native__("Redis.del", conn, key); receive { msg -> msg } }
redisXadd(conn, stream: String, fields: List[(String, String)]) = { __native__("Redis.xadd", conn, stream, fields); receive { msg -> msg } }
redisXlen(conn, stream: String) = { __native__("Redis.xlen", conn, stream); receive { msg -> msg } }
redisXread(conn, streams: List[(String, String)]) = { __native__("Redis.xread", conn, streams); receive { msg -> msg } }
redisXreadCount(conn, streams: List[(String, String)], count: Int) = { __native__("Redis.xread", conn, streams, count); receive { msg -> msg } }
redisXreadBlock(conn, streams: List[(String, String)], count: Int, blockMs: Int) = { __native__("Redis.xread", conn, streams, count, blockMs); receive { msg -> msg } }

isOk(result) = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing XREAD Variants ===")
    conn = redisConnect("redis://127.0.0.1/")

    redisDel(conn, "test:xread")

    f1: List[(String, String)] = [("msg", "one")]
    f2: List[(String, String)] = [("msg", "two")]
    f3: List[(String, String)] = [("msg", "three")]
    redisXadd(conn, "test:xread", f1)
    redisXadd(conn, "test:xread", f2)
    redisXadd(conn, "test:xread", f3)

    ("ok", len) = redisXlen(conn, "test:xread")
    check("Setup - 3 entries", len == 3)

    # Basic XREAD
    streams1: List[(String, String)] = [("test:xread", "0")]
    ("ok", read1) = redisXread(conn, streams1)
    check("XREAD basic", length(read1) > 0)

    # XREAD with COUNT
    streams2: List[(String, String)] = [("test:xread", "0")]
    ("ok", read2) = redisXreadCount(conn, streams2, 2)
    check("XREAD COUNT", length(read2) > 0)

    # XREAD with BLOCK (short timeout, data exists so returns immediately)
    streams3: List[(String, String)] = [("test:xread", "0")]
    ("ok", read3) = redisXreadBlock(conn, streams3, 10, 100)
    check("XREAD BLOCK", length(read3) > 0)

    redisDel(conn, "test:xread")
    println("XREAD tests completed!")
    0
}
