# Test all Stream operations including variants
type Conn = { handle: Any }

redisConnect(url: String) -> Conn = Conn(__native__("Redis.connect", url))
redisDel(conn: Conn, key: String) = { __native__("Redis.del", conn.handle, key); receive { msg -> msg } }
redisXadd(conn: Conn, stream: String, fields: List) = { __native__("Redis.xadd", conn.handle, stream, fields); receive { msg -> msg } }
redisXlen(conn: Conn, stream: String) = { __native__("Redis.xlen", conn.handle, stream); receive { msg -> msg } }
redisXread(conn: Conn, streams: List) = { __native__("Redis.xread", conn.handle, streams); receive { msg -> msg } }
redisXreadCount(conn: Conn, streams: List, count: Int) = { __native__("Redis.xread", conn.handle, streams, count); receive { msg -> msg } }
redisXreadBlock(conn: Conn, streams: List, count: Int, blockMs: Int) = { __native__("Redis.xread", conn.handle, streams, count, blockMs); receive { msg -> msg } }

isOk(result: (String, Any)) -> Bool = match result { ("ok", _) -> true, _ -> false }
check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("=== Testing XREAD Variants ===")
    conn = redisConnect("redis://127.0.0.1/")

    redisDel(conn, "test:xread")

    redisXadd(conn, "test:xread", [("msg", "one")])
    redisXadd(conn, "test:xread", [("msg", "two")])
    redisXadd(conn, "test:xread", [("msg", "three")])

    ("ok", len) = redisXlen(conn, "test:xread")
    check("Setup - 3 entries", len == 3)

    # Basic XREAD
    ("ok", read1) = redisXread(conn, [("test:xread", "0")])
    check("XREAD basic", length(read1) > 0)

    # XREAD with COUNT
    ("ok", read2) = redisXreadCount(conn, [("test:xread", "0")], 2)
    check("XREAD COUNT", length(read2) > 0)

    # XREAD with BLOCK (short timeout, data exists so returns immediately)
    ("ok", read3) = redisXreadBlock(conn, [("test:xread", "0")], 10, 100)
    check("XREAD BLOCK", length(read3) > 0)

    redisDel(conn, "test:xread")
    println("XREAD tests completed!")
    0
}
