# Comprehensive test for all Redis extension functions
# Requires local Redis running at 127.0.0.1:6379

type Conn = { handle: Any }

# Connection
redisConnect(url: String) -> Conn = Conn(__native__("Redis.connect", url))

# Basic operations
redisGet(conn: Conn, key: String) = { __native__("Redis.get", conn.handle, key); receive { msg -> msg } }
redisSet(conn: Conn, key: String, value: String) = { __native__("Redis.set", conn.handle, key, value); receive { msg -> msg } }
redisDel(conn: Conn, key: String) = { __native__("Redis.del", conn.handle, key); receive { msg -> msg } }
redisExists(conn: Conn, key: String) = { __native__("Redis.exists", conn.handle, key); receive { msg -> msg } }
redisPing(conn: Conn) = { __native__("Redis.ping", conn.handle); receive { msg -> msg } }

# Key operations
redisRename(conn: Conn, key: String, newkey: String) = { __native__("Redis.rename", conn.handle, key, newkey); receive { msg -> msg } }
redisType(conn: Conn, key: String) = { __native__("Redis.type", conn.handle, key); receive { msg -> msg } }
redisExpire(conn: Conn, key: String, seconds: Int) = { __native__("Redis.expire", conn.handle, key, seconds); receive { msg -> msg } }
redisTtl(conn: Conn, key: String) = { __native__("Redis.ttl", conn.handle, key); receive { msg -> msg } }

# Counter operations
redisIncr(conn: Conn, key: String) = { __native__("Redis.incr", conn.handle, key); receive { msg -> msg } }
redisIncrby(conn: Conn, key: String, amount: Int) = { __native__("Redis.incrby", conn.handle, key, amount); receive { msg -> msg } }
redisDecr(conn: Conn, key: String) = { __native__("Redis.decr", conn.handle, key); receive { msg -> msg } }
redisDecrby(conn: Conn, key: String, amount: Int) = { __native__("Redis.decrby", conn.handle, key, amount); receive { msg -> msg } }

# Hash operations
redisHset(conn: Conn, key: String, field: String, value: String) = { __native__("Redis.hset", conn.handle, key, field, value); receive { msg -> msg } }
redisHget(conn: Conn, key: String, field: String) = { __native__("Redis.hget", conn.handle, key, field); receive { msg -> msg } }
redisHmset(conn: Conn, key: String, fields: List) = { __native__("Redis.hmset", conn.handle, key, fields); receive { msg -> msg } }
redisHmget(conn: Conn, key: String, fields: List) = { __native__("Redis.hmget", conn.handle, key, fields); receive { msg -> msg } }
redisHincrby(conn: Conn, key: String, field: String, amount: Int) = { __native__("Redis.hincrby", conn.handle, key, field, amount); receive { msg -> msg } }
redisHkeys(conn: Conn, key: String) = { __native__("Redis.hkeys", conn.handle, key); receive { msg -> msg } }
redisHvals(conn: Conn, key: String) = { __native__("Redis.hvals", conn.handle, key); receive { msg -> msg } }
redisHlen(conn: Conn, key: String) = { __native__("Redis.hlen", conn.handle, key); receive { msg -> msg } }
redisHexists(conn: Conn, key: String, field: String) = { __native__("Redis.hexists", conn.handle, key, field); receive { msg -> msg } }

# Set operations
redisSadd(conn: Conn, key: String, member: String) = { __native__("Redis.sadd", conn.handle, key, member); receive { msg -> msg } }
redisSmembers(conn: Conn, key: String) = { __native__("Redis.smembers", conn.handle, key); receive { msg -> msg } }
redisSismember(conn: Conn, key: String, member: String) = { __native__("Redis.sismember", conn.handle, key, member); receive { msg -> msg } }
redisScard(conn: Conn, key: String) = { __native__("Redis.scard", conn.handle, key); receive { msg -> msg } }
redisSunion(conn: Conn, keys: List) = { __native__("Redis.sunion", conn.handle, keys); receive { msg -> msg } }
redisSinter(conn: Conn, keys: List) = { __native__("Redis.sinter", conn.handle, keys); receive { msg -> msg } }
redisSdiff(conn: Conn, keys: List) = { __native__("Redis.sdiff", conn.handle, keys); receive { msg -> msg } }

# Sorted set operations
redisZadd(conn: Conn, key: String, score: Float, member: String) = { __native__("Redis.zadd", conn.handle, key, score, member); receive { msg -> msg } }
redisZscore(conn: Conn, key: String, member: String) = { __native__("Redis.zscore", conn.handle, key, member); receive { msg -> msg } }
redisZrank(conn: Conn, key: String, member: String) = { __native__("Redis.zrank", conn.handle, key, member); receive { msg -> msg } }
redisZrange(conn: Conn, key: String, start: Int, stop: Int) = { __native__("Redis.zrange", conn.handle, key, start, stop); receive { msg -> msg } }
redisZrevrange(conn: Conn, key: String, start: Int, stop: Int) = { __native__("Redis.zrevrange", conn.handle, key, start, stop); receive { msg -> msg } }
redisZincrby(conn: Conn, key: String, increment: Float, member: String) = { __native__("Redis.zincrby", conn.handle, key, increment, member); receive { msg -> msg } }
redisZcard(conn: Conn, key: String) = { __native__("Redis.zcard", conn.handle, key); receive { msg -> msg } }
redisZcount(conn: Conn, key: String, min: Float, max: Float) = { __native__("Redis.zcount", conn.handle, key, min, max); receive { msg -> msg } }

# List operations
redisLpush(conn: Conn, key: String, value: String) = { __native__("Redis.lpush", conn.handle, key, value); receive { msg -> msg } }
redisRpush(conn: Conn, key: String, value: String) = { __native__("Redis.rpush", conn.handle, key, value); receive { msg -> msg } }
redisLpop(conn: Conn, key: String) = { __native__("Redis.lpop", conn.handle, key); receive { msg -> msg } }
redisRpop(conn: Conn, key: String) = { __native__("Redis.rpop", conn.handle, key); receive { msg -> msg } }
redisLrange(conn: Conn, key: String, start: Int, stop: Int) = { __native__("Redis.lrange", conn.handle, key, start, stop); receive { msg -> msg } }
redisLlen(conn: Conn, key: String) = { __native__("Redis.llen", conn.handle, key); receive { msg -> msg } }

# Stream operations
redisXadd(conn: Conn, stream: String, fields: List) = { __native__("Redis.xadd", conn.handle, stream, fields); receive { msg -> msg } }
redisXlen(conn: Conn, stream: String) = { __native__("Redis.xlen", conn.handle, stream); receive { msg -> msg } }
redisXrange(conn: Conn, stream: String, startId: String, endId: String) = { __native__("Redis.xrange", conn.handle, stream, startId, endId); receive { msg -> msg } }

# Test helper
isOk(result: (String, Any)) -> Bool = match result { ("ok", _) -> true, _ -> false }

check(name: String, ok: Bool) = if ok then println("  PASS: " ++ name) else println("  FAIL: " ++ name)

main() = {
    println("Connecting to Redis...")
    conn = redisConnect("redis://127.0.0.1/")

    println("\n=== Testing Basic Operations ===")
    check("PING", isOk(redisPing(conn)))

    redisDel(conn, "test:key")
    check("SET", isOk(redisSet(conn, "test:key", "hello")))

    ("ok", val) = redisGet(conn, "test:key")
    check("GET", val == "hello")

    ("ok", exists) = redisExists(conn, "test:key")
    check("EXISTS", exists == true)
    redisDel(conn, "test:key")

    println("\n=== Testing Counter Operations ===")
    redisDel(conn, "test:counter")
    redisSet(conn, "test:counter", "10")

    ("ok", v1) = redisIncr(conn, "test:counter")
    check("INCR", v1 == 11)

    ("ok", v2) = redisIncrby(conn, "test:counter", 5)
    check("INCRBY", v2 == 16)

    ("ok", v3) = redisDecr(conn, "test:counter")
    check("DECR", v3 == 15)

    ("ok", v4) = redisDecrby(conn, "test:counter", 3)
    check("DECRBY", v4 == 12)
    redisDel(conn, "test:counter")

    println("\n=== Testing Key Operations ===")
    redisSet(conn, "test:rename", "value")
    check("RENAME", isOk(redisRename(conn, "test:rename", "test:renamed")))
    ("ok", ex2) = redisExists(conn, "test:renamed")
    check("Key was renamed", ex2 == true)
    redisDel(conn, "test:renamed")

    redisSet(conn, "test:type", "string_value")
    ("ok", keyType) = redisType(conn, "test:type")
    check("TYPE", keyType == "string")
    redisDel(conn, "test:type")

    redisSet(conn, "test:ttl", "value")
    check("EXPIRE", isOk(redisExpire(conn, "test:ttl", 100)))
    ("ok", ttl) = redisTtl(conn, "test:ttl")
    check("TTL", ttl > 0)
    redisDel(conn, "test:ttl")

    println("\n=== Testing Hash Operations ===")
    redisDel(conn, "test:hash")

    check("HSET", isOk(redisHset(conn, "test:hash", "field1", "value1")))
    ("ok", hval) = redisHget(conn, "test:hash", "field1")
    check("HGET", hval == "value1")

    check("HMSET", isOk(redisHmset(conn, "test:hash", [("f2", "v2"), ("f3", "v3")])))
    ("ok", hmvals) = redisHmget(conn, "test:hash", ["field1", "f2", "f3"])
    check("HMGET", length(hmvals) == 3)

    ("ok", hlen) = redisHlen(conn, "test:hash")
    check("HLEN", hlen == 3)

    ("ok", hkeys) = redisHkeys(conn, "test:hash")
    check("HKEYS", length(hkeys) == 3)

    ("ok", hvals) = redisHvals(conn, "test:hash")
    check("HVALS", length(hvals) == 3)

    redisHset(conn, "test:hash", "counter", "10")
    ("ok", hinc) = redisHincrby(conn, "test:hash", "counter", 5)
    check("HINCRBY", hinc == 15)

    ("ok", hexists) = redisHexists(conn, "test:hash", "field1")
    check("HEXISTS", hexists == true)
    redisDel(conn, "test:hash")

    println("\n=== Testing Set Operations ===")
    redisDel(conn, "test:set1")
    redisDel(conn, "test:set2")

    check("SADD", isOk(redisSadd(conn, "test:set1", "a")))
    redisSadd(conn, "test:set1", "b")
    redisSadd(conn, "test:set1", "c")

    ("ok", scard) = redisScard(conn, "test:set1")
    check("SCARD", scard == 3)

    ("ok", sismember) = redisSismember(conn, "test:set1", "a")
    check("SISMEMBER", sismember == true)

    ("ok", members) = redisSmembers(conn, "test:set1")
    check("SMEMBERS", length(members) == 3)

    redisSadd(conn, "test:set2", "b")
    redisSadd(conn, "test:set2", "c")
    redisSadd(conn, "test:set2", "d")

    ("ok", sunion) = redisSunion(conn, ["test:set1", "test:set2"])
    check("SUNION", length(sunion) == 4)

    ("ok", sinter) = redisSinter(conn, ["test:set1", "test:set2"])
    check("SINTER", length(sinter) == 2)

    ("ok", sdiff) = redisSdiff(conn, ["test:set1", "test:set2"])
    check("SDIFF", length(sdiff) == 1)

    redisDel(conn, "test:set1")
    redisDel(conn, "test:set2")

    println("\n=== Testing Sorted Set Operations ===")
    redisDel(conn, "test:zset")

    check("ZADD", isOk(redisZadd(conn, "test:zset", 1.0, "one")))
    redisZadd(conn, "test:zset", 2.0, "two")
    redisZadd(conn, "test:zset", 3.0, "three")

    ("ok", zcard) = redisZcard(conn, "test:zset")
    check("ZCARD", zcard == 3)

    ("ok", zscore) = redisZscore(conn, "test:zset", "two")
    check("ZSCORE", zscore == 2.0)

    ("ok", zrank) = redisZrank(conn, "test:zset", "two")
    check("ZRANK", zrank == 1)

    ("ok", zrange) = redisZrange(conn, "test:zset", 0, -1)
    check("ZRANGE count", length(zrange) == 3)
    check("ZRANGE first", head(zrange) == "one")

    ("ok", zrevrange) = redisZrevrange(conn, "test:zset", 0, 0)
    check("ZREVRANGE", head(zrevrange) == "three")

    ("ok", zcount) = redisZcount(conn, "test:zset", 1.0, 2.0)
    check("ZCOUNT", zcount == 2)

    ("ok", newscore) = redisZincrby(conn, "test:zset", 0.5, "one")
    check("ZINCRBY", newscore == 1.5)
    redisDel(conn, "test:zset")

    println("\n=== Testing List Operations ===")
    redisDel(conn, "test:list")

    redisLpush(conn, "test:list", "first")
    redisLpush(conn, "test:list", "second")
    redisRpush(conn, "test:list", "third")

    ("ok", llen) = redisLlen(conn, "test:list")
    check("LLEN", llen == 3)

    ("ok", lrange) = redisLrange(conn, "test:list", 0, -1)
    check("LRANGE", length(lrange) == 3)

    ("ok", lpop) = redisLpop(conn, "test:list")
    check("LPOP", lpop == "second")

    ("ok", rpop) = redisRpop(conn, "test:list")
    check("RPOP", rpop == "third")
    redisDel(conn, "test:list")

    println("\n=== Testing Stream Operations ===")
    redisDel(conn, "test:stream")

    ("ok", id1) = redisXadd(conn, "test:stream", [("field1", "value1")])
    check("XADD", length(id1) > 0)

    redisXadd(conn, "test:stream", [("field2", "value2")])

    ("ok", xlen) = redisXlen(conn, "test:stream")
    check("XLEN", xlen == 2)

    ("ok", xrange) = redisXrange(conn, "test:stream", "-", "+")
    check("XRANGE", length(xrange) == 2)
    redisDel(conn, "test:stream")

    println("\n=== All tests completed! ===")
    0
}
