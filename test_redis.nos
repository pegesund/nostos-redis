# Test Redis extension (async version)
# Note: Operations are async and return results via message passing.
# Call the operation, then receive the result.

# Connection type
type Conn = { handle: Any }

# Native function wrappers
# - redisConnect is synchronous (returns connection directly)
# - All other operations are async (return Unit, send result via message)
redisConnect(url: String) -> Conn = Conn(__native__("Redis.connect", url))

# Async wrappers - call then receive
redisPing(conn: Conn) = {
    __native__("Redis.ping", conn.handle)
    receive { msg -> msg }
}

redisSet(conn: Conn, key: String, value: String) = {
    __native__("Redis.set", conn.handle, key, value)
    receive { msg -> msg }
}

redisGet(conn: Conn, key: String) = {
    __native__("Redis.get", conn.handle, key)
    receive { msg -> msg }
}

redisExists(conn: Conn, key: String) = {
    __native__("Redis.exists", conn.handle, key)
    receive { msg -> msg }
}

redisLpush(conn: Conn, key: String, value: String) = {
    __native__("Redis.lpush", conn.handle, key, value)
    receive { msg -> msg }
}

redisLrange(conn: Conn, key: String, start: Int, stop: Int) = {
    __native__("Redis.lrange", conn.handle, key, start, stop)
    receive { msg -> msg }
}

redisDel(conn: Conn, key: String) = {
    __native__("Redis.del", conn.handle, key)
    receive { msg -> msg }
}

main() = {
    println("Connecting to Redis...")
    conn = redisConnect("redis://127.0.0.1/")

    # Test PING
    println("Testing PING...")
    pingResult = redisPing(conn)
    println("PING response: " ++ show(pingResult))

    # Test SET
    println("Testing SET...")
    setResult = redisSet(conn, "nostos:test", "hello from nostos!")
    println("SET response: " ++ show(setResult))

    # Test GET
    println("Testing GET...")
    getResult = redisGet(conn, "nostos:test")
    println("GET response: " ++ show(getResult))

    # Test EXISTS
    println("Testing EXISTS...")
    existsResult = redisExists(conn, "nostos:test")
    println("EXISTS response: " ++ show(existsResult))

    # Test LIST operations
    println("Testing LPUSH...")
    lpush1 = redisLpush(conn, "nostos:list", "item1")
    println("LPUSH response: " ++ show(lpush1))

    lpush2 = redisLpush(conn, "nostos:list", "item2")
    println("LPUSH response: " ++ show(lpush2))

    lrangeResult = redisLrange(conn, "nostos:list", 0, -1)
    println("LRANGE response: " ++ show(lrangeResult))

    # Cleanup
    println("Cleaning up test keys...")
    del1 = redisDel(conn, "nostos:test")
    del2 = redisDel(conn, "nostos:list")

    println("All tests passed!")
    0
}
